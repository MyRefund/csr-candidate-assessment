<script>
const storeKey = "csrAssessmentTimed";
const data = JSON.parse(localStorage.getItem(storeKey) || "{}");

data.answers = data.answers || {};
data.timing = data.timing || {
  startedAt: null,
  submittedAt: null,
  perQuestion: {},
  totalSeconds: 0
};

let currentQuestionStart = null;

const questions = [
  { id:"details", title:"Candidate details", instructions:"Please enter your details.",
    render:()=>`
      <input placeholder="Full name" value="${data.name||""}" oninput="saveField('name',this.value)">
      <input placeholder="Email address" value="${data.email||""}" oninput="saveField('email',this.value)">
    `
  },
  { id:"q1", title:"Customer Email Response", instructions:"Write a professional and empathetic response.",
    scenario:"This is the third time I’ve contacted you and I still don’t have an answer. I was promised a response last week and now I’m being ignored. If this isn’t sorted today, I’ll be taking this further."
  },
  { id:"q2", title:"Prioritisation Scenario", instructions:"List the order you would handle these and explain why.",
    scenario:"1. Angry delayed response\n2. Quick 2-minute question\n3. Non-urgent internal request\n4. Possible double charge"
  },
  { id:"q3", title:"Policy & Compliance – Identity Verification", instructions:"Explain how you would respond while following policy.",
    scenario:"I don’t have a passport or driver licence, but I can send my work ID instead."
  },
  { id:"q4", title:"Empathy & Tone", instructions:"Write a short response (2–4 sentences).",
    scenario:"I know this probably isn’t your fault, but this has been incredibly stressful and I’m really disappointed."
  },
  { id:"q5", title:"Attention to Detail", instructions:"Follow the instructions exactly.",
    render:()=>`
      <input placeholder="READY" value="${data.answers.q5_ready||""}" oninput="saveAnswer('q5_ready',this.value)">
      <input placeholder="DD/MM/YYYY" value="${data.answers.q5_date||""}" oninput="saveAnswer('q5_date',this.value)">
      <textarea placeholder="Why does attention to detail matter? (one sentence)"
        oninput="saveAnswer('q5_reason',this.value)">${data.answers.q5_reason||""}</textarea>
    `
  },
  { id:"q6", title:"Explaining Things Clearly", instructions:"Write a plain-English explanation (3–5 sentences).",
    scenario:"Why does it take a few days for a tax refund to be processed after submission?"
  }
];

let i = 0;

function save(){
  localStorage.setItem(storeKey, JSON.stringify(data));
}

function saveField(key,val){
  data[key]=val;
  save();
}

function saveAnswer(key,val){
  data.answers[key]=val;
  save();
}

function startTiming(){
  if(!data.timing.startedAt){
    data.timing.startedAt = new Date().toISOString();
  }
  currentQuestionStart = Date.now();
}

function endTiming(questionId){
  if(!currentQuestionStart) return;
  const seconds = Math.round((Date.now() - currentQuestionStart)/1000);
  data.timing.perQuestion[questionId] =
    (data.timing.perQuestion[questionId] || 0) + seconds;
  save();
}

function render(){
  const q = questions[i];
  document.getElementById("progress").textContent =
    `Question ${i+1} of ${questions.length}`;

  let html = `<h2>${q.title}</h2><div class="instructions">${q.instructions}</div>`;

  if(q.scenario){
    html += `<blockquote>${q.scenario}</blockquote>
      <textarea oninput="saveAnswer('${q.id}',this.value)">
        ${data.answers[q.id]||""}
      </textarea>`;
  }

  if(q.render) html += q.render();

  document.getElementById("content").innerHTML = html;
  currentQuestionStart = Date.now();
}

function next(){
  const q = questions[i];

  if(i === 0){
    startTiming(); // start assessment timer AFTER details
  } else {
    endTiming(q.id);
  }

  if(i < questions.length-1){
    i++;
    render();
  } else {
    data.timing.submittedAt = new Date().toISOString();
    data.timing.totalSeconds = Math.round(
      (new Date(data.timing.submittedAt) - new Date(data.timing.startedAt)) / 1000
    );
    save();
    console.log("FINAL SUBMISSION:", data);
    alert("Assessment complete. Thank you.");
  }
}

render();
</script>
